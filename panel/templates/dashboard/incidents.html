{% extends "base.html" %}
{% load dashboard_tags %}

{% block title %}Incidentes{% endblock %}
{% block page_title %}Incidentes Forenses{% endblock %}

{% block content %}
<!-- Filters -->
<div class="card mb-2">
  <form method="get" class="flex items-center gap-2 flex-wrap">
    <div class="form-group" style="margin-bottom:0;width:auto">
      <label>Evento</label>
      <select name="event" onchange="this.form.submit()" style="width:auto">
        <option value="">Todos</option>
        <option value="OPEN" {% if event_filter == 'OPEN' %}selected{% endif %}>OPEN</option>
        <option value="ACCESS" {% if event_filter == 'ACCESS' %}selected{% endif %}>ACCESS</option>
        <option value="MODIFY" {% if event_filter == 'MODIFY' %}selected{% endif %}>MODIFY</option>
        <option value="DELETE" {% if event_filter == 'DELETE' %}selected{% endif %}>DELETE</option>
      </select>
    </div>
    <div class="form-group" style="margin-bottom:0;width:auto">
      <label>Token</label>
      <input type="text" name="token" value="{{ token_filter }}" placeholder="Filtrar por ID..." style="width:200px">
    </div>
    <button type="submit" class="btn btn-blue" style="margin-top:1rem">Filtrar</button>
  </form>
</div>

<div class="text-muted mb-1">{{ total }} incidente{{ total|pluralize:"s" }} encontrado{{ total|pluralize:"s" }}</div>

<!-- Incidents Table -->
<div class="card">
  <table>
    <thead>
      <tr>
        <th>ID Incidente</th>
        <th>Evento</th>
        <th>Token</th>
        <th>Archivo Accedido</th>
        <th>Timestamp</th>
        <th>Evidencia</th>
      </tr>
    </thead>
    <tbody>
      {% for inc in incidents %}
      <tr>
        <td><a href="{% url 'dashboard:incident_detail' inc.incident_id %}" class="mono">{{ inc.incident_id }}</a></td>
        <td>
          {% with event=inc.metadata.event|default:"?" %}
          <span class="badge {% if event == 'DELETE' or event == 'DELETED' %}badge-red{% elif event == 'MODIFY' or event == 'MODIFIED' %}badge-yellow{% else %}badge-blue{% endif %}">{{ event }}</span>
          {% endwith %}
        </td>
        <td>
          {% if inc.metadata.canary_id %}
          <a href="{% url 'dashboard:token_detail' inc.metadata.canary_id %}" class="mono" style="font-size:.82rem">{{ inc.metadata.canary_id }}</a>
          {% else %}
          <span class="text-muted">N/A</span>
          {% endif %}
        </td>
        <td class="mono text-muted" style="font-size:.8rem">{{ inc.metadata.file_accessed|default:"N/A"|short_path:40 }}</td>
        <td class="mono text-muted" style="font-size:.8rem">{{ inc.metadata.timestamp_iso|default:"N/A" }}</td>
        <td class="text-muted">{{ inc.file_count }} archivos</td>
      </tr>
      {% empty %}
      <tr><td colspan="6" class="empty-state">No hay incidentes registrados</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Pagination -->
{% if total_pages > 1 %}
<div class="pagination">
  {% if page > 1 %}<a href="?page={{ page|add:"-1" }}&event={{ event_filter }}&token={{ token_filter }}">&laquo;</a>{% endif %}
  {% for p in page_range %}
  {% if p == page %}<span class="current">{{ p }}</span>
  {% else %}<a href="?page={{ p }}&event={{ event_filter }}&token={{ token_filter }}">{{ p }}</a>{% endif %}
  {% endfor %}
  {% if page < total_pages %}<a href="?page={{ page|add:"1" }}&event={{ event_filter }}&token={{ token_filter }}">&raquo;</a>{% endif %}
</div>
{% endif %}
{% endblock %}
